# Work Effort: Event-Driven Architecture Upgrade

## Status: In Progress
**Started:** 2025-12-07 03:51
**Last Updated:** 2025-12-07 03:51

## Objective
Upgrade NovaSystem's repository processing system from a "Transaction Script" architecture to a "Domain-Driven, Event-Sourced" architecture. This decouples the "what" (business logic) from the "how" (execution details).

## Architecture Overview

### Current State (Transaction Script)
- Monolithic `Nova.process_repository()` method in `novasystem/tools/nova.py`
- Linear, procedural orchestration
- Tight coupling between CLI, DB, and core logic
- Simple deny-list command validation
- Single Docker executor

### Target State (Domain-Driven, Event-Sourced)
- **Event Bus** - Decouples all consumers (CLI, DB, Web) via pub/sub
- **State Machine** - Formal run status transitions with recovery semantics
- **Pipeline** - Discrete, hookable steps with retry/skip capabilities
- **Repository Strategies** - Per-language installers (Python, Node, Rust, Go)
- **Policy Objects** - Composable, auditable command validation
- **Container Runtime Adapter** - Abstract Docker/Podman/shell execution

## Implementation Order
1. âœ… Event Bus (Observer) - Break tight coupling first
2. ğŸ”„ State Machine - Formalize run lifecycles
3. â³ Pipeline - Refactor `process_repository` into steps
4. â³ Repository Strategies - Per-language handlers

## New Directory Structure
```
novasystem/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ events.py          # Event Bus + Event types
â”‚   â”œâ”€â”€ state_machine.py   # Run state machine
â”‚   â”œâ”€â”€ pipeline.py        # Pipeline orchestrator
â”‚   â””â”€â”€ models.py          # Domain models (Run, CommandLog)
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py            # RepositoryStrategy interface
â”‚   â”œâ”€â”€ python.py          # Python strategy
â”‚   â”œâ”€â”€ node.py            # Node strategy
â”‚   â”œâ”€â”€ rust.py            # Rust strategy
â”‚   â””â”€â”€ go.py              # Go strategy
â”œâ”€â”€ policies/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ command_policy.py  # Composable command policies
â””â”€â”€ adapters/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ runtime.py         # Container runtime adapter interface
    â”œâ”€â”€ docker_adapter.py  # Docker implementation
    â””â”€â”€ shell_adapter.py   # Local shell fallback
```

## Tasks
1. [x] Create work effort documentation
2. [ ] Implement Event Bus (`domain/events.py`)
3. [ ] Implement State Machine (`domain/state_machine.py`)
4. [ ] Implement Domain Models (`domain/models.py`)
5. [ ] Implement Pipeline (`domain/pipeline.py`)
6. [ ] Implement Repository Strategies (`strategies/`)
7. [ ] Implement Policy Objects (`policies/`)
8. [ ] Implement Container Runtime Adapters (`adapters/`)
9. [ ] Refactor Nova to use new architecture
10. [ ] Update tests
11. [ ] Update documentation

## Event Types
```python
# Run Lifecycle Events
RunCreated(run_id, repo_url, timestamp)
RunStatusChanged(run_id, old_status, new_status, timestamp)
RunCompleted(run_id, success, summary, timestamp)

# Pipeline Events
StepStarted(run_id, step_name, timestamp)
StepCompleted(run_id, step_name, result, timestamp)
StepFailed(run_id, step_name, error, timestamp)

# Command Events
CommandQueued(run_id, command, timestamp)
CommandStarted(run_id, command, timestamp)
CommandOutput(run_id, command, output_type, chunk, timestamp)
CommandCompleted(run_id, command, exit_code, timestamp)

# Policy Events
PolicyViolation(run_id, command, policy_name, reason, timestamp)
PolicyOverride(run_id, command, policy_name, user, timestamp)
```

## State Machine States
```
Pending â†’ Analyzing â†’ Gated â†’ Running â†’ Paused â†’ Finalized
                        â†“                   â†“
                     (user override)    (resume)
```

- **Pending**: Run created, clone starting
- **Analyzing**: Strategy detection, doc parsing active
- **Gated**: Policy violation detected, awaiting user decision
- **Running**: Docker container executing commands
- **Paused**: Execution suspended (container stopped, not killed)
- **Finalized**: Terminal state (Success, Failure, Cancelled, Archived)

## Progress
- [2025-12-07] Created work effort, starting Event Bus implementation

## Notes
- Keep backwards compatibility with existing `Nova` class during transition
- Event Bus can start as simple synchronous callbacks, upgrade to async later
- State Machine should persist to DB for crash recovery

## References
- Mermaid diagrams provided by user showing architecture
- Original `novasystem/tools/nova.py` implementation
- User's architectural maturity audit
